# CFH TypeScript Migration — Main Review (Run 20250923_2212)

**Contract:** Generate TypeSafe `.ts`/`.tsx` using **“@” path aliases** only (no `../`), write to `artifacts/generated/20250923_2212/`, and **fail-closed on SHA1 conflict**. Run with `AIO_RUN_GATES=1`. Gates must pass:
- Vendor: no tracked files under `node_modules/`, `.venv/`, `artifacts/`, `dist/`, `build/`
- No-JS: no tracked `*.js` / `*.jsx` (configs allowed as `*.cjs`/`*.mjs`)
- CFH Lint (hard): `tsc --noEmit` (and eslint/prettier if config exists)

**Tiers:** Free → Premium → Wow++. Keep patterns minimal, portable, and TypeSafe.

---

### Free 01 — Types: LoanTerms shape
```ts
// path: @types/finance/LoanTerms.ts
export interface LoanTerms {
  principal: number;   // dollars
  rateApr:  number;    // annual rate, 0..1
  termMonths: number;  // total months
}
Free 02 — Finance math: monthly interest factor
ts
Copy code
// path: @utils/finance/monthly.ts
export const monthlyRate = (apr: number): number => {
  if (!Number.isFinite(apr) || apr < 0) throw new Error("apr must be >= 0");
  return apr / 12;
};
Free 03 — Calculator: payment (no AI)
ts
Copy code
// path: @utils/finance/payment.ts
import { monthlyRate } from "@utils/finance/monthly";

/** Standard amortized payment; returns dollars/month */
export function calcMonthlyPayment(principal: number, apr: number, termMonths: number): number {
  if (termMonths <= 0) throw new Error("termMonths must be > 0");
  const r = monthlyRate(apr);
  if (r === 0) return +(principal / termMonths).toFixed(2);
  const num = principal * r;
  const den = 1 - Math.pow(1 + r, -termMonths);
  return +((num / den)).toFixed(2);
}
Premium 01 — Guard: TypeSafe validation helpers
ts
Copy code
// path: @utils/financeGuard.ts
export const isPositive = (n: number) => Number.isFinite(n) && n > 0;
export const isRate = (r: number) => Number.isFinite(r) && r >= 0 && r < 1;
export function ensureLoan(principal: number, rateApr: number, termMonths: number) {
  if (!isPositive(principal)) throw new Error("principal must be > 0");
  if (!isRate(rateApr)) throw new Error("rateApr in [0,1)");
  if (!Number.isInteger(termMonths) || termMonths <= 0) throw new Error("termMonths integer > 0");
}
Premium 02 — Service: typed façade
ts
Copy code
// path: @services/LoanCalculator.ts
import { ensureLoan } from "@utils/financeGuard";
import { calcMonthlyPayment } from "@utils/finance/payment";
import type { LoanTerms } from "@types/finance/LoanTerms";

export function monthlyPayment(terms: LoanTerms): number {
  ensureLoan(terms.principal, terms.rateApr, terms.termMonths);
  return calcMonthlyPayment(terms.principal, terms.rateApr, terms.termMonths);
}
Wow++ — AI-enhanced planner with required calculateMonthly()
ts
Copy code
// path: @ai/loanPlanner.ts
import type { LoanTerms } from "@types/finance/LoanTerms";
import { monthlyPayment } from "@services/LoanCalculator";

export interface LoanPlan {
  terms: LoanTerms;
  monthly: number;
  totalCost: number;
}

export const AIOptimizer = {
  /** required by spec: calculateMonthly() */
  calculateMonthly(terms: LoanTerms): number {
    return monthlyPayment(terms);
  },
  plan(terms: LoanTerms): LoanPlan {
    const monthly = monthlyPayment(terms);
    return {
      terms,
      monthly,
      totalCost: +(monthly * terms.termMonths).toFixed(2),
    };
  },
};
Generation Notes

Use imports via “@” aliases only (e.g., @types/…, @utils/…, @ai/…, @services/…).

Emit to artifacts/generated/20250923_2212/… with identical paths as shown in // path: comments.

Validate with gates; if any gate fails, do not overwrite prior files (fail closed).

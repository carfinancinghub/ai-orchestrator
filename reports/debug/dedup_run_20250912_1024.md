**********************
PowerShell transcript start
Start time: 20250912102408
Username: Agasi\Agasi5
RunAs User: Agasi\Agasi5
Configuration Name: 
Machine: AGASI (Microsoft Windows NT 10.0.26100.0)
Host Application: C:\Program Files\PowerShell\7\pwsh.dll
Process ID: 63212
PSVersion: 7.5.3
PSEdition: Core
GitCommitId: 7.5.3
OS: Microsoft Windows 10.0.26100
Platform: Win32NT
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1, 6.0, 7.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
WSManStackVersion: 3.0
**********************
PS C:\c\ai-orchestrator>
PS C:\c\ai-orchestrator>
(.venv) Write-Host "=== STEP 1: Write app/dedup_cli.py ==="
=== STEP 1: Write app/dedup_cli.py ===
PS C:\c\ai-orchestrator>
(.venv) Set-Location $AIO
PS C:\c\ai-orchestrator>
(.venv) New-Item -ItemType Directory -Force -Path "$AIO\app" | Out-Null
PS C:\c\ai-orchestrator>
PS C:\c\ai-orchestrator>
(.venv) @'
from __future__ import annotations
import argparse, csv, hashlib, os, re, shutil, sys
from pathlib import Path
from typing import Iterable, Dict, List, Tuple

NUMERIC_RUN = re.compile(r"\d{3,}")  # any 3+ consecutive digits

PREF_ORDER = [".ts", ".tsx", ".js", ".jsx"]

def is_numeric_junk(stem: str) -> bool:
    s = stem.strip().lower()
    if not s:
        return True
    # all digits (>=3)
    if s.isdigit() and len(s) >= 3:
        return True
    # contains any 3+ digit run
    if NUMERIC_RUN.search(s):
        return True
    return False

def iter_files(roots: Iterable[Path], exts: Iterable[str], skip_dirs: Iterable[str]) -> Iterable[Path]:
    exts_l = {("." + e.lower().lstrip(".")) for e in exts}
    skip_set = {d.lower() for d in skip_dirs}
    for root in roots:
        root = Path(root)
        if not root.exists():
            continue
        for p in root.rglob("*"):
            if p.is_dir():
                # skip by directory name anywhere in path
                if any(part.lower() in skip_set for part in p.parts):
                    continue
                continue
            if any(part.lower() in skip_set for part in p.parts):
                continue
            ext = p.suffix.lower()
            if ext in exts_l and not is_numeric_junk(p.stem):
                yield p

def choose_best(files: List[Path]) -> Path:
    # prefer by extension order; tie-break by shortest path (stable)
    files = sorted(files, key=lambda p: (PREF_ORDER.index(p.suffix.lower()) if p.suffix.lower() in PREF_ORDER else 99, len(str(p))))
    return files[0]

def main(argv: List[str]) -> int:
    ap = argparse.ArgumentParser(description="CFH dedup + numeric junk filter")
    ap.add_argument("--roots", help="CSV list of roots; else AIO_SCAN_ROOTS; else CWD", default=None)
    ap.add_argument("--skip-dirs", default="node_modules,dist,.git,build,coverage,.cache,.next,.turbo,.yarn,.pnpm-store,storybook-static,out")
    ap.add_argument("--exts", default="js,jsx,ts,tsx")
    ap.add_argument("--out", default=r"C:\cfh_consolidated")
    ap.add_argument("--reports", default="reports")
    args = ap.parse_args(argv)

    roots = []
    if args.roots:
        roots = [Path(p.strip()) for p in args.roots.split(",") if p.strip()]
    else:
        env_roots = os.getenv("AIO_SCAN_ROOTS", "")
        roots = [Path(p.strip()) for p in env_roots.split(",") if p.strip()] or [Path.cwd()]

    skip_dirs = [s.strip() for s in args.skip_dirs.split(",") if s.strip()]
    exts = [e.strip() for e in args.exts.split(",") if e.strip()]

    out_dir = Path(args.out)
    out_dir.mkdir(parents=True, exist_ok=True)

    reports_root = Path(args.reports)
    reports_root.mkdir(parents=True, exist_ok=True)
    reports_root.joinpath("debug").mkdir(parents=True, exist_ok=True)

    groups: Dict[Tuple[str,int], List[Path]] = {}
    candidates: List[Path] = []

    for f in iter_files(roots, exts, skip_dirs):
        key = (f.stem.lower(), f.stat().st_size)
        groups.setdefault(key, []).append(f)

    keepers: List[Path] = []
    eliminated_rows = []

    for key, files in groups.items():
        keep = choose_best(files)
        keepers.append(keep)
        discarded = [p for p in files if p != keep]
        eliminated_rows.append({
            "stem": key[0],
            "size": key[1],
            "keep": str(keep),
            "kept_ext": keep.suffix.lower(),
            "discard_count": len(discarded),
            "total": len(files)
        })
        if keep.suffix.lower() in (".js", ".jsx"):
            candidates.append(keep)

    # Copy keepers into out_dir (ensure uniqueness)
    for i, src in enumerate(keepers):
        digest = hashlib.sha1(str(src).encode("utf-8")).hexdigest()[:8]
        dest = out_dir / (src.stem + src.suffix)
        if dest.exists():
            dest = out_dir / f"{src.stem}_{digest}{src.suffix}"
        try:
            dest.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(src, dest)
        except Exception as e:
            print(f"[copy] WARN {src} -> {dest}: {e}", file=sys.stderr)

    # Write reports
    dup_csv = reports_root / "duplicates_eliminated.csv"
    with dup_csv.open("w", newline="", encoding="utf-8") as f:
        w = csv.DictWriter(f, fieldnames=["stem","size","keep","kept_ext","discard_count","total"])
        w.writeheader()
        for row in sorted(eliminated_rows, key=lambda r: (r["stem"], r["size"])):
            w.writerow(row)

    cand_txt = reports_root / "conversion_candidates.txt"
    with cand_txt.open("w", encoding="utf-8") as f:
        for c in sorted(candidates, key=lambda p: str(p).lower()):
            f.write(str(c) + "\n")

    print(f'{{"ok": true, "keepers": {len(keepers)}, "candidates": {len(candidates)}, "out": "{out_dir}"}}')
    return 0

if __name__ == "__main__":
    raise SystemExit(main(sys.argv[1:]))
'@ | Set-Content -Path "$AIO\app\dedup_cli.py" -Encoding UTF8
PS C:\c\ai-orchestrator>
PS C:\c\ai-orchestrator>
(.venv) Write-Host "=== STEP 2: Run dedup with numeric-junk filter (transcript captures output) ==="
=== STEP 2: Run dedup with numeric-junk filter (transcript captures output) ===
PS C:\c\ai-orchestrator>
(.venv) Set-Location $AIO
PS C:\c\ai-orchestrator>
(.venv) $env:AIO_SCAN_ROOTS = "C:/Backup_Projects/CFH/frontend,C:/Backup_Projects/CFH/backend,C:/cfh,C:/TruthSource,C:/cfh_backup_20250713,C:/cfh_backup20250713,M:/cfh"
PS C:\c\ai-orchestrator>
(.venv) python -m app.dedup_cli --roots $env:AIO_SCAN_ROOTS --out $CONSOLIDATE --reports "reports"

PS C:\c\ai-orchestrator>
PS C:\c\ai-orchestrator>
(.venv) Write-Host "=== STEP 3: Commit & push transcript log ==="
=== STEP 3: Commit & push transcript log ===
PS C:\c\ai-orchestrator>
(.venv) git config commit.gpgsign false | Out-Null
PS C:\c\ai-orchestrator>
(.venv) if (-not (git config user.email)) { git config user.email "ci@local" | Out-Null }
PS C:\c\ai-orchestrator>
(.venv) if (-not (git config user.name))  { git config user.name  "Local CI" | Out-Null }
PS C:\c\ai-orchestrator>
(.venv) $env:GIT_ASKPASS = "echo"
PS C:\c\ai-orchestrator>
(.venv) git fetch origin 2>$null | Out-Null
PS C:\c\ai-orchestrator>
(.venv) $existsLocal  = (git branch --list $AIO_BRANCH)
PS C:\c\ai-orchestrator>
(.venv) $existsRemote = (git ls-remote --heads origin $AIO_BRANCH)
PS C:\c\ai-orchestrator>
(.venv) if     ($existsLocal)  { git switch $AIO_BRANCH | Out-Null }
PS C:\c\ai-orchestrator>
(.venv) elseif ($existsRemote) { git switch -c $AIO_BRANCH origin/$AIO_BRANCH | Out-Null }
>> TerminatingError(): "The term 'elseif' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again."
The term 'elseif' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again.
elseif: The term 'elseif' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again.
PS C:\c\ai-orchestrator>
(.venv) else                   { git checkout -B $AIO_BRANCH | Out-Null }
>> TerminatingError(): "The term 'else' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again."
The term 'else' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again.
else: The term 'else' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again.
PS C:\c\ai-orchestrator>
PS C:\c\ai-orchestrator>
(.venv) git add -- app\dedup_cli.py reports\duplicates_eliminated.csv reports\conversion_candidates.txt $log

PS C:\c\ai-orchestrator>
(.venv) git commit --allow-empty --no-verify -m "feat: dedup runner w/ numeric-junk filter + reports ($ts)" | Out-Null
PS C:\c\ai-orchestrator>
(.venv) git push -u origin $AIO_BRANCH

PS C:\c\ai-orchestrator>
PS C:\c\ai-orchestrator>
(.venv) # URL print
PS C:\c\ai-orchestrator>
(.venv) $remote = git remote get-url origin 2>$null
PS C:\c\ai-orchestrator>
(.venv) $ownerRepo = ($remote -match "github\.com[:/](.+?)(\.git)?$") ? $Matches[1] : "carfinancinghub/ai-orchestrator"
PS C:\c\ai-orchestrator>
(.venv) $repoPosix = ($PWD.Path -replace "\\","/")
PS C:\c\ai-orchestrator>
(.venv) $logPosix  = ($log -replace "\\","/")
PS C:\c\ai-orchestrator>
(.venv) $relLog    = $logPosix.Substring($repoPosix.Length + 1)
PS C:\c\ai-orchestrator>
(.venv) $blobUrl   = "https://github.com/$ownerRepo/blob/$AIO_BRANCH/$relLog"
PS C:\c\ai-orchestrator>
(.venv) try { Stop-Transcript | Out-Null } catch {}
**********************
PowerShell transcript end
End time: 20250912102429
**********************
